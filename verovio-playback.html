<!DOCTYPE html>
<!-- Version 2.4.10 -->
<head>
  <meta charset="utf-8">
  <meta http-equiv='cache-control' content='no-cache'> 
  <meta http-equiv='expires' content='0'> 
  <meta http-equiv='pragma' content='no-cache'>
  
  <title>Verovio MIDI Player</title>
  <link href="https://book.verovio.org/tutorials/midi.css" rel="stylesheet" type="text/css" />
  <script src="https://www.verovio.org/javascript/latest/verovio-toolkit-wasm.js" defer></script>
  <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfkit/0.13.0/pdfkit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blob-stream/0.1.3/blob-stream.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #notation {
      border: 1px solid #ccc;
      margin-top: 20px;
      overflow-x: auto; /* For horizontal scrolling if content is wider */
    }
    .currently-playing {
      fill: #ff0000; /* Highlight notes in red */
      stroke: #ff0000;
    }

    /* --- New CSS for the Paper Size Modal --- */
    #paperSizeModal {
      display: none; /* Changed from 'flex' to 'none' */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
      justify-content: center; /* Center horizontally */
      align-items: center; /* Center vertically */
      /* display: flex; will be set by JS when needed */
    }

    #paperSizeModal > div {
      background-color: #fefefe;
      margin: auto; /* For browsers that don't support flex centering */
      padding: 30px;
      border: 1px solid #888;
      width: 90%; /* Could be more specific */
      max-width: 350px; /* Max width for larger screens */
      border-radius: 8px;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      text-align: center;
    }

    #paperSizeModal h2 {
        margin-top: 0;
        color: #333;
    }

    #paperSizeModal label {
        margin-left: 5px;
        font-size: 1.1em;
    }

    #paperSizeModal input[type="radio"] {
        margin-bottom: 10px;
    }

    #paperSizeModal button {
        padding: 10px 20px;
        margin: 10px 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
    }

    #paperSizeModal button#generatePdfButton {
        background-color: #4CAF50; /* Green */
        color: white;
    }

    #paperSizeModal button#generatePdfButton:hover {
        background-color: #45a049;
    }

    #paperSizeModal button#cancelPdfButton {
        background-color: #f44336; /* Red */
        color: white;
    }

    #paperSizeModal button#cancelPdfButton:hover {
        background-color: #da190b;
    }

    .currently-playing {
      fill: #ff0000;
      stroke: #ff0000;
    }
  </style>
</head>
<body>
  <h1>Hello Verovio!</h1>
  <button id="loadAudio">Load Audio</button>
  <button id="stopMIDI">Stop</button>
  <button id="printPDF">Print</button>
  <midi-player id="verovio-midi-player" sound-font="https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus" controls="false" style="display: none;">
  </midi-player>
  <div id="notation"></div>

  <div id="paperSizeModal">
    <div>
      <h2>Choose Paper Size</h2>
      <input type="radio" id="paperLetter" name="paperSize" value="LETTER" checked>
      <label for="paperLetter">Letter (8.5" x 11")</label><br><br>
      <input type="radio" id="paperA4" name="paperSize" value="A4">
      <label for="paperA4">A4 (210mm x 297mm)</label><br><br>
      <input type="radio" id="paperA5" name="paperSize" value="A5">
      <label for="paperA5">A5 (148mm x 210mm)</label><br><br>
      <input type="radio" id="paperOctavo" name="paperSize" value="OCTAVO">
      <label for="paperOctavo">Choral (Octavo ~6.75" x 10.5")</label><br><br>
      <button id="generatePdfButton">Generate PDF</button>
      <button id="cancelPdfButton">Cancel</button>
    </div>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
    let tk = null;        // Verovio toolkit instance for display
    let tk_pdf = null;    // Verovio toolkit instance for PDF generation

    let zoom = 70;
    let trInterval = 0;

    const player = document.querySelector('#verovio-midi-player');
    const loadAudioButton = document.getElementById('loadAudio');
    const stopMIDIButton = document.getElementById('stopMIDI');
    const printPDFButton = document.getElementById('printPDF');
    const paperSizeModal = document.getElementById('paperSizeModal');
    const generatePdfButton = document.getElementById('generatePdfButton');
    const cancelPdfButton = document.getElementById('cancelPdfButton');

    let timemap = null;
    let currentlyHighlightedVerovioIds = new Set();
    let highlightInterval = null; // NEW: Interval handle for highlighting

    // --- BEGIN: Helper functions (not used by main flow, kept for possible future use) ---
    const highlightId = 'data-highlight';
    function highlightNote(note, id = '') {
        if (!note) return;
        note.classList.add('currently-playing');
        if (id) note.setAttribute(highlightId, id);
        note.querySelectorAll('g').forEach((g) => g.classList.add('currently-playing'));
    }
    function unhighlightNote(note) {
        if (!note) return;
        note.classList.remove('currently-playing');
        note.removeAttribute(highlightId);
        note.querySelectorAll('.currently-playing').forEach((g) => g.classList.remove('currently-playing'));
    }
    function unHighlightAllElements() {
        document.querySelectorAll('.currently-playing').forEach((g) => g.classList.remove('currently-playing'));
    }
    // --- END ---

    function showAlert(message) {
        const alertBox = document.createElement('div');
        alertBox.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            border-radius: 8px;
            text-align: center;
            font-family: sans-serif;
            color: #333;
        `;
        alertBox.innerHTML = `
            <p>${message}</p>
            <button style="margin-top: 15px; padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="this.parentNode.remove()">OK</button>
        `;
        document.body.appendChild(alertBox);
    }

    // --- HIGHLIGHTING LOGIC: uses timemap, called every 50ms during playback ---
    function updateNoteHighlights(currentTimeMs) {
        // Uncomment for debugging:
        // console.log("Highlight tick", currentTimeMs);
        if (!timemap) return;
        let lastEventIndex = -1;
        for (let i = 0; i < timemap.length; i++) {
            if (timemap[i].tstamp <= currentTimeMs) lastEventIndex = i;
            else break;
        }
        if (lastEventIndex === -1) {
            // console.log("No events yet for this time.");
            return;
        }

        let onNotes = new Set();
        for (let i = 0; i <= lastEventIndex; i++) {
            if (timemap[i].on) timemap[i].on.forEach(id => onNotes.add(id));
            if (timemap[i].off) timemap[i].off.forEach(id => onNotes.delete(id));
        }

        // Remove highlights for notes that should not be on
        currentlyHighlightedVerovioIds.forEach(id => {
            if (!onNotes.has(id)) {
                const noteElement = document.getElementById(id);
                if (noteElement) noteElement.classList.remove("currently-playing");
                currentlyHighlightedVerovioIds.delete(id);
                // console.log("Unhighlighted:", id, noteElement);
            }
        });

        // Add highlights for notes that should be on
        onNotes.forEach(id => {
            if (!currentlyHighlightedVerovioIds.has(id)) {
                const noteElement = document.getElementById(id);
                // console.log("Trying to highlight:", id, noteElement);
                if (noteElement) {
                    noteElement.classList.add("currently-playing");
                    currentlyHighlightedVerovioIds.add(id);
                    // console.log("Highlighted:", id, noteElement);
                } // else {
                  // console.log("Element not found for:", id);
                // }
            }
        });
    }

    verovio.module.onRuntimeInitialized = () => {
        tk = new verovio.toolkit();
        tk_pdf = new verovio.toolkit();

        // Calculate pageWidth and pageHeight
        let pWidth = window.innerWidth;
        let pageWidthBase;
        if (pWidth < 1270) {
            pageWidthBase = (pWidth - 30) * 100 / zoom;
        } else {
            pageWidthBase = 1270 * 100 / zoom;
        }
        let pageHeight = window.innerHeight * 100 / zoom;

        // Set options for Verovio DISPLAY
        tk.setOptions({
            pageHeight: pageHeight,
            pageWidth: (pageWidthBase - 100) * 0.96,
            scale: zoom,
            adjustPageHeight: true,
            transpose: trInterval,
            spacingLinear: 0.35,
            scaleToPageSize: true,
            svgAdditionalAttribute: ["note@pname", "note@oct"]
        });

        let currentPage = 1;

        // --- Unified Handler for 'Load Audio' button ---
        const loadAudioAndPlayHandler = async () => {
    player.style.display = 'block';
    try {
        await Tone.start();
        console.log("Tone.js AudioContext resumed.");
    } catch (error) {
        console.error("Failed to resume Tone.js AudioContext:", error);
        showAlert("Failed to start audio. Please ensure browser allows autoplay or interact with the page.");
        return;
    }

    // Always regenerate MIDI and set src, to guarantee playback starts from beginning
    let base64midi = tk.renderToMIDI();
    player.src = 'data:audio/midi;base64,' + base64midi;

    // Force player to reload the new source
    if (typeof player.load === "function") player.load();

    // Stop any existing playback first
    if (typeof player.stop === "function") player.stop();

    // Small timeout ensures the player has loaded the new MIDI
    setTimeout(() => {
        if (typeof player.start === "function") player.start();
        console.log("player.start() called.");
    }, 300);

    // Start highlight interval (if not already running)...
    if (highlightInterval) clearInterval(highlightInterval);
    highlightInterval = setInterval(() => {
        if (player && !player.paused && !player.ended) {
            updateNoteHighlights(player.currentTime * 1000);
        }
    }, 50);
};

        // --- Stop MIDI and highlighting ---
        const stopMIDIHandler = () => {
            player.stop();
            // Stop highlight interval
            if (highlightInterval) {
                clearInterval(highlightInterval);
                highlightInterval = null;
            }
            // Clear all highlights from the DOM
            currentlyHighlightedVerovioIds.forEach(id => {
                const noteElement = document.getElementById(id);
                if (noteElement) noteElement.classList.remove("currently-playing");
            });
            currentlyHighlightedVerovioIds.clear();
            console.log("MIDI stopped. All highlights cleared.");
        };

        // --- Load MEI Data and Render SVG ---
        fetch("https://www.verovio.org/examples/downloads/Schubert_Lindenbaum.mei")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(meiXML => {
                tk.loadData(meiXML);
                tk_pdf.loadData(meiXML);
                timemap = tk.renderToTimemap();
                console.log("Timemap created:", timemap);

                // Render the initial SVG for display
                document.getElementById("notation").innerHTML = tk.renderToSVG(currentPage);

                // --- Attach Event Listeners and Callbacks after data is loaded ---
                loadAudioButton.addEventListener("click", loadAudioAndPlayHandler);
                stopMIDIButton.addEventListener("click", stopMIDIHandler);

                // Remove this event: handled by setInterval now
                // player.addEventListener('timeupdate', ...);

                // --- Print PDF Modal logic (unchanged) ---
                printPDFButton.addEventListener('click', function() {
                    paperSizeModal.style.display = 'flex';
                });
                cancelPdfButton.addEventListener('click', function() {
                    paperSizeModal.style.display = 'none';
                });
                generatePdfButton.addEventListener('click', async function() {
                    paperSizeModal.style.display = 'none';
                    const selectedSizeElement = document.querySelector('input[name="paperSize"]:checked');
                    const selectedPaperSize = selectedSizeElement ? selectedSizeElement.value : 'LETTER';
                    await generatePDF(selectedPaperSize);
                });

                // --- PDF Generation Logic (unchanged) ---
                async function generatePDF(selectedPaperSize) {
                    console.log(`Generating PDF for ${selectedPaperSize} paper size...`);
                    if (!tk_pdf || tk_pdf.getMEI() === '') {
                        showAlert("Verovio PDF toolkit is not ready or no MEI data loaded. Please load a score first.");
                        console.error("Verovio PDF Toolkit (tk_pdf) not initialized or MEI data is empty.");
                        return;
                    }
                    try {
                        const originalPdfOptions = tk_pdf.getOptions();
                        const paperSizeOptions = {
                            'LETTER': {
                                pdfkitSize: 'LETTER',
                                verovioPageWidth: 2000,
                                verovioPageHeight: 1100,
                                verovioScale: 40
                            },
                            'A4': {
                                pdfkitSize: 'A4',
                                verovioPageWidth: 2000,
                                verovioPageHeight: 1180,
                                verovioScale: 40
                            },
                            'A5': {
                                pdfkitSize: 'A5',
                                verovioPageWidth: 2000,
                                verovioPageHeight: 830,
                                verovioScale: 40
                            },
                            'OCTAVO': {
                                pdfkitSize: [486, 756],
                                verovioPageWidth: 2000,
                                verovioPageHeight: 1050,
                                verovioScale: 40
                            }
                        };
                        const currentPaperSettings = paperSizeOptions[selectedPaperSize];
                        let doc = new PDFDocument({
                            size: currentPaperSettings.pdfkitSize,
                            layout: 'portrait',
                            margins: { top: 10, bottom: 10, left: 10, right: 10 }
                        });
                        const stream = doc.pipe(blobStream());
                        stream.on('finish', function() {
                            const blob = stream.toBlob('application/pdf');
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = `verovio-output-${selectedPaperSize.toLowerCase()}.pdf`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            console.log('PDF download initiated from Verovio SVG.');
                            showAlert("PDF exported successfully!");
                        });
                        stream.on('error', function(err) {
                            console.error("Error creating PDF stream:", err);
                            showAlert("An error occurred during PDF creation.");
                        });
                        tk_pdf.setOptions({
                            scale: currentPaperSettings.verovioScale,
                            pageWidth: currentPaperSettings.verovioPageWidth,
                            pageHeight: currentPaperSettings.verovioPageHeight,
                            adjustPageHeight: true
                        });
                        console.log("Verovio PDF options set for PDF generation before rendering pages.");
                        const pageCount = tk_pdf.getPageCount();
                        if (pageCount === 0) {
                            throw new Error("Verovio PDF toolkit reports no pages to render. Check MEI data.");
                        }
                        console.log("Total pages to render for PDF:", pageCount);
                        for (let i = 1; i <= pageCount; i++) {
                            const svgString = tk_pdf.renderToSVG(i);
                            console.log(`Processing SVG page ${i} from PDF toolkit. Length: ${svgString.length}. First 200 chars:`, svgString.substring(0, 200));
                            if (typeof svgString !== 'string' || svgString.trim() === '' || !svgString.startsWith('<svg')) {
                                console.error(`SVG string for page ${i} from PDF toolkit is invalid or empty:`, svgString);
                                throw new Error(`Invalid or malformed SVG content for page ${i}.`);
                            }
                            const drawableWidth = doc.page.width - doc.page.margins.left - doc.page.margins.right;
                            const drawableHeight = doc.page.height - doc.page.margins.top - doc.page.margins.bottom;
                            await SVGtoPDF(doc, svgString, doc.page.margins.left, doc.page.margins.top, {
                                width: drawableWidth,
                                height: drawableHeight,
                                preserveAspectRatio: 'xMidYMid meet',
                                assumeGIsCursive: true
                            });
                        }
                        doc.end();
                        tk_pdf.setOptions(originalPdfOptions);
                    } catch (error) {
                        console.error("Failed to generate PDF:", error);
                        showAlert("Failed to generate PDF. Check console for details.");
                    }
                }
            })
            .catch(error => {
                console.error("Error loading or processing MEI data:", error);
                showAlert("Error loading or processing MEI data. Check console for details.");
            });
    };
});
</script>
</body>
</html>
